<!doctype html>

<script type="module">

  async function init() {

    const { instance } = await WebAssembly.instantiateStreaming(
      fetch("print.wasm"),
    );
    var mem = instance.exports.memory.buffer;
    var ptr = 2048;
    var len = ptr - mem.byteLength;
    var mem = new Uint8Array(mem, ptr, 128);

    var res_len = instance.exports.wasm_test(ptr, 128);

    var UTF8Decoder =
      typeof TextDecoder != "undefined" ? new TextDecoder() : undefined;
    let output = UTF8Decoder.decode(mem);
    console.log(output);
    const parser = new DOMParser();
    let fragment = parser.parseFromString(output, "text/html");
    let root = document.getElementById("test_wasm_root");
    root.appendChild(fragment.childNodes[0]);
  }

  async function init2() {
    //const memory = new WebAssembly.Memory({ initial: 1, maximum: 10 });
    const { instance } = await WebAssembly.instantiateStreaming(
      fetch("print.wasm"),
      // {
      //   env: { memory }  // Pass the memory to the module
      // }
    );
    
    // // Hello from WebAssembly!
    // const stringPtr = instance.exports.getHelloString();
    // const wasmMemory = new Uint8Array(instance.exports.memory.buffer);
    // // Read the string from WebAssembly memory
    // let resultString = "";
    // for (let i = stringPtr; wasmMemory[i] !== 0; i++) {
    //   resultString += String.fromCharCode(wasmMemory[i]);
    // }
    // console.log(resultString);


    function stringToPointer(str) {
      const encoder = new TextEncoder();
      const encodedString = encoder.encode(str);
      const length = encodedString.length;

      const ptr = instance.exports.malloc(length + 1); // Allocate memory
      const memory = new Uint8Array(instance.exports.memory.buffer);
      memory.set(encodedString, ptr);
      memory[ptr + length] = 0; // Null terminate the string

      return ptr;
    }

    function pointerToString(ptr) {
      const memory = new Uint8Array(instance.exports.memory.buffer);
      let str = "";
      for (let i = ptr; memory[i] !== 0; i++) {
        str += String.fromCharCode(memory[i]);
      }
      return str;
    }
    function printBuffer(length) {
      const memory = new Uint8Array(instance.exports.memory.buffer);
      let str = "";
      for (let i = 0; i < length; i++) {
        str += String.fromCharCode(memory[i]);
      }
      console.log(str);
    }

    //Hello from WebAssembly!
    // const jsString = "Hello fromdsfs JavaScript!";
    // const ptr = stringToPointer(jsString);
    // var t = instance.exports.firstLetter(ptr);
    // instance.exports.free(ptr);
    // console.log(t);

    const jsString1 = "/hello";
    const ptr1 = stringToPointer(jsString1);
    var ptrResult = instance.exports.wasm_engine(ptr1);
    var result = pointerToString(ptrResult);
    console.log(result);


    printBuffer(100);
    //instance.exports.free(ptr1);
    //console.log(ptrResult);

    // const wasmMemory1 = new Uint8Array(instance.exports.memory.buffer);
    // // Read the string from WebAssembly memory
    // let resultString1 = "";
    // for (let i = ptrResult; wasmMemory1[i] !== 0; i++) {
    //   resultString1 += String.fromCharCode(wasmMemory1[i]);
    // }

    // console.log(resultString1);




    // var mem = instance.exports.memory.buffer;
    // var ptr = 2048;
    // var len = ptr - mem.byteLength;
    // var mem = new Uint8Array(mem, ptr, 128);

    // var res_len = instance.exports.wasm_test(ptr, 128);

    // var UTF8Decoder =
    //   typeof TextDecoder != "undefined" ? new TextDecoder() : undefined;
    // let output = UTF8Decoder.decode(mem);
    // console.log(output);
    // const parser = new DOMParser();
    // let fragment = parser.parseFromString(output, "text/html");
    // let root = document.getElementById("test_wasm_root");
    // root.appendChild(fragment.childNodes[0]);
  }

  // init();
  init2();
</script>

<body>
  <div id="test_wasm_root"></div>
</body>